<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; line-height: 1.6; }
        .main-container { display: flex; height: 100vh; overflow: hidden; }

        /* Left Panel - Tools */
        .left-panel { width: 320px; min-width: 280px; max-width: 400px; background: #161b22; border-right: 1px solid #30363d; display: flex; flex-direction: column; }
        .left-panel-header { padding: 16px; border-bottom: 1px solid #30363d; background: #161b22; }
        .left-panel-header h2 { font-size: 16px; color: #58a6ff; margin-bottom: 10px; }
        .tools-upload { margin-top: 10px; }
        .tools-upload label { display: block; margin-bottom: 8px; color: #8b949e; font-size: 12px; }
        .tools-upload input[type="file"] { display: block; width: 100%; padding: 8px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; cursor: pointer; font-size: 12px; }
        .tools-upload input[type="file"]::-webkit-file-upload-button { background: #238636; border: none; color: #ffffff; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 12px; }
        .tools-info { margin-top: 8px; color: #238636; font-size: 11px; }
        .tools-search { padding: 12px 16px; border-bottom: 1px solid #30363d; }
        .tools-search input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 12px; border-radius: 6px; font-size: 13px; }
        .tools-search input:focus { outline: none; border-color: #1f6feb; }
        .tools-list { flex: 1; overflow-y: auto; padding: 8px; }
        .tools-list::-webkit-scrollbar { width: 6px; }
        .tools-list::-webkit-scrollbar-track { background: #0d1117; }
        .tools-list::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }

        /* Tool Item */
        .tool-item { background: #21262d; border: 1px solid #30363d; border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
        .tool-item.hidden { display: none; }
        .tool-header { padding: 12px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px; }
        .tool-header:hover { background: #30363d; }
        .tool-toggle { color: #8b949e; transition: transform 0.2s; font-size: 10px; flex-shrink: 0; }
        .tool-toggle.expanded { transform: rotate(180deg); }
        .tool-name { font-size: 13px; font-weight: 600; color: #58a6ff; flex: 1; word-break: break-word; }
        .tool-content { display: none; padding: 12px; border-top: 1px solid #30363d; background: #0d1117; }
        .tool-content.expanded { display: block; }
        .tool-description { font-size: 12px; color: #c9d1d9; margin-bottom: 12px; line-height: 1.5; }
        .tool-schema { margin-top: 8px; }
        .tool-schema-label { font-size: 11px; font-weight: 600; color: #8b949e; margin-bottom: 6px; }
        .tool-schema pre { background: #21262d; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; color: #c9d1d9; }
        .tool-empty { text-align: center; padding: 40px 20px; color: #8b949e; font-size: 13px; }

        /* Right Panel - Original Content */
        .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .container { max-width: 100%; padding: 20px; overflow-y: auto; flex: 1; }
        header { background: #161b22; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #30363d; }
        h1 { font-size: 24px; color: #58a6ff; margin-bottom: 10px; }
        .file-upload { margin-top: 15px; padding: 15px; background: #21262d; border-radius: 6px; border: 1px dashed #30363d; }
        .file-upload label { display: block; margin-bottom: 10px; color: #8b949e; font-size: 14px; }
        .file-upload input[type="file"] { display: block; width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; cursor: pointer; }
        .file-upload input[type="file"]::-webkit-file-upload-button { background: #238636; border: none; color: #ffffff; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .file-loaded { margin-top: 10px; color: #238636; font-size: 13px; }
        .stats { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; }
        .stat { background: #21262d; padding: 8px 16px; border-radius: 6px; font-size: 14px; }
        .stat-label { color: #8b949e; }
        .stat-value { color: #58a6ff; font-weight: bold; }
        .filters { background: #161b22; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #30363d; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .filter-btn { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        .filter-btn:hover { background: #30363d; }
        .filter-btn.active { background: #1f6feb; border-color: #1f6feb; color: #ffffff; }
        .filter-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .search-box { flex: 1; min-width: 200px; }
        .search-box input { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 12px; border-radius: 6px; font-size: 14px; }
        .search-box input:focus { outline: none; border-color: #1f6feb; }
        .search-box input:disabled { opacity: 0.5; }

        /* Step Blocks */
        .step-blocks { display: flex; flex-direction: column; gap: 16px; }
        .step-block { background: #161b22; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; }
        .step-block.hidden { display: none; }
        .step-block-header { padding: 12px 16px; background: #1f6feb; border-bottom: 1px solid #30363d; display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; }
        .step-block-header:hover { background: #1a66e0; }
        .step-block-title { font-weight: 700; color: #ffffff; font-size: 15px; }
        .step-block-info { color: #d0d7de; font-size: 12px; }
        .step-block-toggle { color: #ffffff; transition: transform 0.2s; margin-left: auto; }
        .step-block-toggle.expanded { transform: rotate(180deg); }
        .step-block-content { display: none; padding: 0; }
        .step-block-content.expanded { display: block; }

        /* Conversation Items */
        .conversation { display: flex; flex-direction: column; gap: 12px; }
        .conv-item { border-bottom: 1px solid #21262d; }
        .conv-item:last-child { border-bottom: none; }

        /* Message Section */
        .message-section { padding: 12px 16px; background: #0d1117; }
        .message-role { font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 6px; }
        .message-role.user { color: #58a6ff; }
        .message-role.system { color: #8b949e; }
        .message-role.assistant { color: #238636; }
        .message-content { font-size: 13px; color: #c9d1d9; }

        /* Thinking Section */
        .thinking-section { padding: 10px 16px; background: #161b22; border-top: 1px solid #21262d; border-bottom: 1px solid #21262d; }
        .thinking-header { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; padding: 4px 0; }
        .thinking-label { font-size: 11px; font-weight: 600; color: #8957e5; text-transform: uppercase; }
        .thinking-toggle { color: #8957e5; transition: transform 0.2s; font-size: 10px; }
        .thinking-toggle.expanded { transform: rotate(180deg); }
        .thinking-content { display: none; margin-top: 8px; padding: 8px; background: #0d111733; border-radius: 4px; border-left: 2px solid #8957e5; }
        .thinking-content.expanded { display: block; }
        .thinking-text { color: #a5d6ff; font-style: italic; font-size: 12px; white-space: pre-wrap; }

        /* Response Section */
        .response-section { padding: 12px 16px; background: #0d1117; }
        .response-label { font-size: 11px; font-weight: 600; color: #238636; text-transform: uppercase; margin-bottom: 8px; }
        .response-content { font-size: 13px; color: #c9d1d9; }
        .response-content.markdown-content p { margin-bottom: 8px; }
        .response-content.markdown-content code { background: #21262d; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 12px; }
        .response-content.markdown-content pre { background: #21262d; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 10px 0; }
        .response-content.markdown-content pre code { background: transparent; padding: 0; }

        /* Tool Use Section */
        .tool-section { padding: 10px 16px; background: #161b22; border-top: 1px solid #21262d; }
        .tool-header { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; padding: 4px 0; }
        .tool-label { font-size: 11px; font-weight: 600; color: #db6d28; text-transform: uppercase; }
        .tool-count { background: #db6d28; color: #ffffff; font-size: 10px; padding: 1px 6px; border-radius: 10px; }
        .tool-toggle { color: #db6d28; transition: transform 0.2s; font-size: 10px; }
        .tool-toggle.expanded { transform: rotate(180deg); }
        .tool-content { display: none; margin-top: 8px; }
        .tool-content.expanded { display: block; }
        .tool-item { background: #0d1117; padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 2px solid #db6d28; }
        .tool-item:last-child { margin-bottom: 0; }
        .tool-name { font-size: 12px; font-weight: 600; color: #db6d28; margin-bottom: 6px; }
        .tool-details { font-size: 11px; color: #8b949e; }
        .tool-details pre { margin: 4px 0 0; padding: 8px; background: #21262d; border-radius: 4px; overflow-x: auto; }
        .tool-details code { font-family: monospace; font-size: 11px; }

        .placeholder { text-align: center; padding: 60px 40px; color: #8b949e; }
        .placeholder-icon { font-size: 48px; margin-bottom: 16px; }
        .empty { text-align: center; padding: 40px; color: #8b949e; }
        .empty-thinking { color: #8b949e; font-style: italic; font-size: 12px; }
        .empty-response { color: #8b949e; font-style: italic; font-size: 12px; }
        .error { background: #da3633; color: #ffffff; padding: 16px; border-radius: 8px; margin: 20px 0; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Panel - Tools -->
        <div class="left-panel">
            <div class="left-panel-header">
                <h2>üîß Tools</h2>
                <div class="tools-upload">
                    <label for="toolsFile">Load tools.json:</label>
                    <input type="file" id="toolsFile" accept=".json">
                    <div id="toolsInfo" class="tools-info"></div>
                </div>
            </div>
            <div class="tools-search">
                <input type="text" id="toolsSearchInput" placeholder="Search tools..." disabled>
            </div>
            <div class="tools-list" id="toolsList">
                <div class="tool-empty">No tools loaded</div>
            </div>
        </div>

        <!-- Right Panel - Original Content -->
        <div class="right-panel">
            <div class="container">
                <header>
                    <h1>Conversation Viewer</h1>
                    <div class="file-upload">
                        <label for="jsonFile">Select merged.json file to view:</label>
                        <input type="file" id="jsonFile" accept=".json">
                        <div id="fileInfo" class="file-loaded"></div>
                    </div>
                    <div class="stats" id="stats"></div>
                </header>

                <div class="filters">
                    <button class="filter-btn" data-type="all" disabled>All</button>
                    <button class="filter-btn" data-type="user" disabled>User Msg</button>
                    <button class="filter-btn" data-type="assistant" disabled>Assistant</button>
                    <button class="filter-btn" data-type="thinking" disabled>Thinking</button>
                    <button class="filter-btn" data-type="tool" disabled>Tools</button>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search content..." disabled>
                    </div>
                </div>

                <div class="step-blocks" id="stepBlocks">
                    <div class="placeholder">
                        <div class="placeholder-icon">üí¨</div>
                        <div class="placeholder-text">Please select a JSON file to view conversations</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tools Panel Logic
        let toolsData = [];
        let toolsSearchQuery = '';

        document.getElementById('toolsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    toolsData = JSON.parse(event.target.result);
                    document.getElementById('toolsInfo').textContent = `‚úì Loaded ${toolsData.length} tools`;
                    document.getElementById('toolsSearchInput').disabled = false;
                    renderToolsList();
                } catch (error) {
                    document.getElementById('toolsList').innerHTML = `<div class="error" style="margin: 10px;">Error parsing JSON: ${error.message}</div>`;
                    document.getElementById('toolsInfo').textContent = `‚úó Error loading file`;
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('toolsSearchInput').addEventListener('input', function(e) {
            toolsSearchQuery = e.target.value.toLowerCase();
            renderToolsList();
        });

        function renderToolsList() {
            const container = document.getElementById('toolsList');
            if (!toolsData || toolsData.length === 0) {
                container.innerHTML = '<div class="tool-empty">No tools loaded</div>';
                return;
            }

            const filteredTools = toolsData.filter(tool => {
                if (!toolsSearchQuery) return true;
                const name = (tool.name || '').toLowerCase();
                const desc = (tool.description || '').toLowerCase();
                return name.includes(toolsSearchQuery) || desc.includes(toolsSearchQuery);
            });

            if (filteredTools.length === 0) {
                container.innerHTML = '<div class="tool-empty">No tools found</div>';
                return;
            }

            let html = '';
            filteredTools.forEach(tool => {
                html += createToolItemHTML(tool);
            });
            container.innerHTML = html;
            addToolItemHandlers();
        }

        function createToolItemHTML(tool) {
            const name = escapeHtml(tool.name || 'unnamed');
            const description = tool.description ? escapeHtml(tool.description) : 'No description';
            const inputSchema = tool.input_schema ? JSON.stringify(tool.input_schema, null, 2) : '{}';

            return `
                <div class="tool-item">
                    <div class="tool-header">
                        <span class="tool-toggle">‚ñ∂</span>
                        <span class="tool-name">${name}</span>
                    </div>
                    <div class="tool-content">
                        <div class="tool-description">${description}</div>
                        ${tool.input_schema ? `
                            <div class="tool-schema">
                                <div class="tool-schema-label">Input Schema:</div>
                                <pre><code>${escapeHtml(inputSchema)}</code></pre>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function addToolItemHandlers() {
            document.querySelectorAll('#toolsList .tool-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const toggle = header.querySelector('.tool-toggle');
                    content.classList.toggle('expanded');
                    toggle.classList.toggle('expanded');
                });
            });
        }

        // Original Conversation Viewer Logic
        let allData = {};
        let currentFilter = 'all';
        let searchQuery = '';

        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        document.getElementById('jsonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    allData = JSON.parse(event.target.result);
                    const stepCount = Object.keys(allData).length;
                    document.getElementById('fileInfo').textContent = `‚úì Loaded: ${file.name} (${stepCount} steps)`;
                    enableControls();
                    renderStepBlocks();
                    updateStats();
                } catch (error) {
                    document.getElementById('stepBlocks').innerHTML = `<div class="error">Error parsing JSON: ${error.message}</div>`;
                    document.getElementById('fileInfo').textContent = `‚úó Error loading file`;
                }
            };
            reader.readAsText(file);
        });

        function enableControls() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.disabled = false);
            document.getElementById('searchInput').disabled = false;
        }

        function updateStats() {
            let stepCount = 0, totalConvItems = 0, totalMessages = 0;
            let userMsgCount = 0, assistantMsgCount = 0, thinkingCount = 0, toolUseCount = 0;
            Object.entries(allData).forEach(([step, convItems]) => {
                stepCount++;
                if (Array.isArray(convItems)) {
                    convItems.forEach(item => {
                        totalConvItems++;
                        if (item.message && Array.isArray(item.message)) {
                            totalMessages += item.message.length;
                            item.message.forEach(msg => {
                                if (msg.role === 'user') userMsgCount++;
                                else if (msg.role === 'assistant') assistantMsgCount++;
                            });
                        }
                        if (item.thinking) thinkingCount++;
                        if (item.tool_use && item.tool_use.length > 0) toolUseCount++;
                    });
                }
            });
            document.getElementById('stats').innerHTML = `
                <div class="stat"><span class="stat-label">Steps:</span> <span class="stat-value">${stepCount}</span></div>
                <div class="stat"><span class="stat-label">Items:</span> <span class="stat-value">${totalConvItems}</span></div>
                <div class="stat"><span class="stat-label">User Msgs:</span> <span class="stat-value">${userMsgCount}</span></div>
                <div class="stat"><span class="stat-label">Thinking:</span> <span class="stat-value">${thinkingCount}</span></div>
                <div class="stat"><span class="stat-label">Tool Uses:</span> <span class="stat-value">${toolUseCount}</span></div>
            `;
        }

        function renderStepBlocks() {
            const container = document.getElementById('stepBlocks');
            if (!allData || Object.keys(allData).length === 0) {
                container.innerHTML = '<div class="empty">No data found</div>';
                return;
            }
            let html = '';
            Object.entries(allData).forEach(([step, convItems]) => {
                html += createStepBlockHTML(step, convItems);
            });
            container.innerHTML = html;
            addBlockHandlers();
        }

        function createStepBlockHTML(step, convItems) {
            if (!Array.isArray(convItems)) return '';
            const totalItems = convItems.length;
            const filteredItems = filterConvItems(convItems);
            if (filteredItems.length === 0) {
                return `<div class="step-block hidden" data-step="${escapeHtml(step)}"></div>`;
            }
            const conversationHTML = filteredItems.map((item, index) => createConvItemHTML(item, index)).join('');
            return `
                <div class="step-block" data-step="${escapeHtml(step)}">
                    <div class="step-block-header">
                        <span class="step-block-title">${escapeHtml(step)}</span>
                        <span class="step-block-info">${filteredItems.length}/${totalItems} items</span>
                        <span class="step-block-toggle">‚ñº</span>
                    </div>
                    <div class="step-block-content">
                        <div class="conversation">${conversationHTML}</div>
                    </div>
                </div>
            `;
        }

        function createConvItemHTML(item, index) {
            let html = '<div class="conv-item">';

            // Message section
            if (item.message && Array.isArray(item.message) && item.message.length > 0) {
                const shouldShow = currentFilter === 'all' || currentFilter === 'user' || currentFilter === 'assistant';
                if (shouldShow) {
                    html += '<div class="message-section">';
                    item.message.forEach(msg => {
                        if (currentFilter !== 'all' && currentFilter !== msg.role) return;
                        const roleClass = msg.role || 'system';
                        const content = formatMessageContent(msg.content);
                        html += `
                            <div class="message-block">
                                <div class="message-role ${roleClass}">${msg.role || 'system'}</div>
                                <div class="message-content">${content}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            // Thinking section
            if (item.thinking && item.thinking.trim()) {
                const shouldShow = currentFilter === 'all' || currentFilter === 'thinking';
                if (shouldShow) {
                    const escapedThinking = escapeHtml(item.thinking);
                    html += `
                        <div class="thinking-section">
                            <div class="thinking-header">
                                <span class="thinking-label">üí≠ Thinking</span>
                                <span class="thinking-toggle">‚ñº</span>
                            </div>
                            <div class="thinking-content">
                                <div class="thinking-text">${escapedThinking}</div>
                            </div>
                        </div>
                    `;
                }
            }

            // Response (text) section
            if (item.text && item.text.trim()) {
                html += `
                    <div class="response-section">
                        <div class="response-label">üìù Response</div>
                        <div class="response-content" style="white-space: pre-wrap; word-break: break-word;">${escapeHtml(item.text)}</div>
                    </div>
                `;
            }

            // Tool use section
            if (item.tool_use && Array.isArray(item.tool_use) && item.tool_use.length > 0) {
                const shouldShow = currentFilter === 'all' || currentFilter === 'tool';
                if (shouldShow) {
                    const toolsHTML = item.tool_use.map(tool => {
                        const toolName = tool.subagent_type || tool.name || 'unknown';
                        const toolDesc = tool.description || tool.prompt || '';
                        const otherFields = Object.keys(tool).filter(k => k !== 'subagent_type' && k !== 'name' && k !== 'description' && k !== 'prompt');
                        const otherFieldsHTML = otherFields.length > 0 ? `
                            <details>
                                <summary style="cursor: pointer; color: #58a6ff;">Additional fields</summary>
                                <pre><code>${escapeHtml(JSON.stringify(tool, null, 2))}</code></pre>
                            </details>
                        ` : '';
                        return `
                            <div class="tool-item">
                                <div class="tool-name">${escapeHtml(toolName)}</div>
                                ${toolDesc ? `<div class="tool-details">${escapeHtml(toolDesc).substring(0, 200)}${toolDesc.length > 200 ? '...' : ''}</div>` : ''}
                                ${otherFieldsHTML}
                            </div>
                        `;
                    }).join('');
                    html += `
                        <div class="tool-section">
                            <div class="tool-header">
                                <span class="tool-label">üîß Tools</span>
                                <span class="tool-count">${item.tool_use.length}</span>
                                <span class="tool-toggle">‚ñº</span>
                            </div>
                            <div class="tool-content">
                                ${toolsHTML}
                            </div>
                        </div>
                    `;
                }
            }

            html += '</div>';
            return html;
        }

        function formatMessageContent(content) {
            if (typeof content === 'string') {
                return `<div style="white-space: pre-wrap; word-break: break-word;">${escapeHtml(content)}</div>`;
            }
            if (Array.isArray(content)) {
                return content.map(part => {
                    if (typeof part === 'string') return `<div style="white-space: pre-wrap; word-break: break-word;">${escapeHtml(part)}</div>`;
                    if (part.type === 'text') return `<div style="white-space: pre-wrap; word-break: break-word;">${escapeHtml(part.text || '')}</div>`;
                    if (part.type === 'image_url') return `<span>[Image: ${escapeHtml(part.image_url?.url?.substring(0, 50) || 'unknown')}...]</span>`;
                    return `<pre><code>${escapeHtml(JSON.stringify(part, null, 2))}</code></pre>`;
                }).join('');
            }
            return `<pre><code>${escapeHtml(JSON.stringify(content, null, 2))}</code></pre>`;
        }

        function filterConvItems(convItems) {
            let filtered = convItems;
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(item => {
                    if (item.message) {
                        const msgStr = JSON.stringify(item.message).toLowerCase();
                        if (msgStr.includes(query)) return true;
                    }
                    if (item.thinking && item.thinking.toLowerCase().includes(query)) return true;
                    if (item.text && item.text.toLowerCase().includes(query)) return true;
                    if (item.tool_use) {
                        const toolStr = JSON.stringify(item.tool_use).toLowerCase();
                        if (toolStr.includes(query)) return true;
                    }
                    return false;
                });
            }
            return filtered;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addBlockHandlers() {
            document.querySelectorAll('.step-block-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const toggle = header.querySelector('.step-block-toggle');
                    content.classList.toggle('expanded');
                    toggle.classList.toggle('expanded');
                });
            });
            document.querySelectorAll('.thinking-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const content = header.nextElementSibling;
                    const toggle = header.querySelector('.thinking-toggle');
                    content.classList.toggle('expanded');
                    toggle.classList.toggle('expanded');
                });
            });
            document.querySelectorAll('.tool-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const content = header.nextElementSibling;
                    const toggle = header.querySelector('.tool-toggle');
                    content.classList.toggle('expanded');
                    toggle.classList.toggle('expanded');
                });
            });
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.type;
                renderStepBlocks();
            });
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value;
            renderStepBlocks();
        });

        document.querySelector('.filter-btn[data-type="all"]').classList.add('active');
    </script>
</body>
</html>
